#!/bin/sh

. /usr/share/libubox/jshn.sh

##################################################################################################################
#
#  Copyright 2026 RafaÅ‚ Wabik - IceG - From eko.one.pl forum
#  
#  MIT License
#  
##################################################################################################################

ACTIVITY_THRESHOLD=2000

check_activity() {
    local port="$1"
    local port_path="/sys/class/net/$port"
    
    local rx_bytes_file="$port_path/statistics/rx_bytes"
    local tx_bytes_file="$port_path/statistics/tx_bytes"
    
    if [ ! -f "$rx_bytes_file" ] || [ ! -f "$tx_bytes_file" ]; then
        echo "idle"
        return
    fi
    
    local rx1 tx1 rx2 tx2
    rx1=$(cat "$rx_bytes_file" 2>/dev/null || echo "0")
    tx1=$(cat "$tx_bytes_file" 2>/dev/null || echo "0")
    
    sleep 0.5
    
    rx2=$(cat "$rx_bytes_file" 2>/dev/null || echo "0")
    tx2=$(cat "$tx_bytes_file" 2>/dev/null || echo "0")
    
    local rx_diff=$((rx2 - rx1))
    local tx_diff=$((tx2 - tx1))
    local total_diff=$((rx_diff + tx_diff))
    
    if [ "$total_diff" -gt "$ACTIVITY_THRESHOLD" ]; then
        echo "active"
    else
        echo "idle"
    fi
}

get_port_status() {
    local port="$1"
    local port_path="/sys/class/net/$port"
    local operstate="unknown"
    
    if [ ! -d "$port_path" ]; then
        echo "unknown"
        return
    fi
    
    if [ -f "$port_path/operstate" ]; then
        operstate=$(cat "$port_path/operstate" 2>/dev/null || echo "unknown")
    fi
    
    local flags=""
    if [ -f "$port_path/flags" ]; then
        flags=$(cat "$port_path/flags" 2>/dev/null || echo "0x0")
    fi
    
    local carrier=0
    if [ -f "$port_path/carrier" ]; then
        carrier=$(cat "$port_path/carrier" 2>/dev/null || echo "0")
    fi
   
    if [ "$operstate" = "down" ]; then
        local flags_decimal=$(printf "%d" "$flags" 2>/dev/null || echo "0")
        local is_up=$((flags_decimal & 1))
        
        if [ "$is_up" = "0" ]; then
            echo "disabled"
            return
        fi
    fi
    
    if [ "$carrier" != "1" ]; then
        echo "down"
        return
    fi
    
    if [ "$operstate" = "unknown" ] && [ "$carrier" = "1" ]; then
        operstate="up"
    fi
    
    if [ "$carrier" = "1" ]; then
        local activity=$(check_activity "$port")
        echo "$activity"
        return
    fi
    
    echo "$operstate"
}

get_all_ports_status() {
    local tmpdir
    tmpdir=$(mktemp -d)
    local pids=""

    for port_path in /sys/class/net/*; do
        if [ -d "$port_path" ]; then
            port_name=$(basename "$port_path")
            case "$port_name" in
                lo|dummy*|tunl*|gre*|gretap*|sit*|ip6tnl*|ip6gre*|br-*)
                    continue
                    ;;
                eth*|lan*|wan*|en*|sfp*)
                    if [ -f "$port_path/address" ]; then
                        (
                            status=$(get_port_status "$port_name")
                            echo "${port_name}=${status}" > "$tmpdir/$port_name"
                        ) &
                        pids="$pids $!"
                    fi
                    ;;
            esac
        fi
    done

    for pid in $pids; do
        wait "$pid" 2>/dev/null
    done

    json_init
    for result_file in "$tmpdir"/*; do
        [ -f "$result_file" ] || continue
        line=$(cat "$result_file")
        port_name="${line%%=*}"
        status="${line#*=}"
        json_add_string "$port_name" "$status"
    done
    rm -rf "$tmpdir"

    json_dump
}

set_port_status() {
    local port="$1"
    local status="$2"
    
    if [ ! -d "/sys/class/net/$port" ]; then
        json_init
        json_add_boolean "success" 0
        json_add_string "error" "Port not found"
        json_dump
        return 1
    fi
    
    if [ "$status" = "up" ]; then
        ip link set "$port" up 2>/dev/null
    elif [ "$status" = "down" ]; then
        ip link set "$port" down 2>/dev/null
    else
        json_init
        json_add_boolean "success" 0
        json_add_string "error" "Invalid status"
        json_dump
        return 1
    fi
    
    if [ $? -eq 0 ]; then
        json_init
        json_add_boolean "success" 1
        json_dump
        return 0
    else
        json_init
        json_add_boolean "success" 0
        json_add_string "error" "Failed to change port status"
        json_dump
        return 1
    fi
}

case "$1" in
    list)
        json_init
        json_add_object "getPortsStatus"
        json_close_object
        json_add_object "setPortStatus"
            json_add_string "port" "port"
            json_add_string "status" "status"
        json_close_object
        json_dump
        ;;
    call)
        case "$2" in
            getPortsStatus)
                get_all_ports_status
                ;;
            setPortStatus)
                read input
                port=$(echo "$input" | jsonfilter -e '@.port')
                status=$(echo "$input" | jsonfilter -e '@.status')
                set_port_status "$port" "$status"
                ;;
        esac
        ;;
esac
